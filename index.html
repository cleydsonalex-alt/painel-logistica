<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogisticsInsight | Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; margin: 0; transition: 0.3s; }
        .navbar { background: white; border-bottom: 1px solid #e2e8f0; padding: 1rem; position: sticky; top: 0; z-index: 1000; }
        .card-kpi { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        body.dark-mode { background: #0f172a; color: #f1f5f9; }
        body.dark-mode .navbar { background: #1e293b; border-color: #334155; }
        body.dark-mode .card-kpi { background: #1e293b; border-color: #334155; color: white; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #94a3b8; }
        .dot-online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .next-up { background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 12px; border-radius: 8px; margin-top: 10px; }
        body.dark-mode .next-up { background: #0c4a6e; border-left-color: #38bdf8; }
        .badge-uf { background: #e2e8f0; color: #475569; font-weight: 700; font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>
<nav class="navbar mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="fw-bold text-primary fs-4"><i class="fa-solid fa-users-gear me-2"></i>LogisticsInsight</span>
        <div class="d-flex gap-3 align-items-center">
            <div class="small fw-bold"><span id="statusDot" class="dot"></span> <span id="statusText">CONECTANDO...</span></div>
            <button onclick="document.body.classList.toggle('dark-mode')" class="btn btn-sm btn-outline-secondary border-0"><i class="fa-solid fa-moon"></i></button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row mb-4">
        <div class="col-12"><select id="filterUf" class="form-select shadow-sm" onchange="processData()"><option value="TODOS">üåç Todos os Estados</option></select></div>
    </div>

    <div class="row text-center mb-2">
        <div class="col-4"><div class="card-kpi"><small class="fw-bold text-muted">VISITAS</small><h2 id="kpiVisitas" class="fw-bold mt-2">0</h2></div></div>
        <div class="col-4"><div class="card-kpi"><small class="fw-bold text-muted">INSTAL.</small><h2 id="kpiInstalacoes" class="fw-bold text-success mt-2">0</h2></div></div>
        <div class="col-4"><div class="card-kpi border-primary"><small class="fw-bold text-muted">T√âCNICOS</small><h2 id="kpiTotal" class="fw-bold text-primary mt-2">0</h2></div></div>
    </div>

    <div class="card-kpi mb-4 border-info">
        <h6 class="fw-bold text-info mb-3"><i class="fa-solid fa-rotate me-2"></i>ROD√çZIO</h6>
        <div class="row g-2">
            <div class="col-md-6"><div class="next-up"><small class="fw-bold opacity-75">PR√ìX. VT:</small><br><span id="nextVT" class="fw-bold fs-5 text-primary">---</span></div></div>
            <div class="col-md-6"><div class="next-up" style="border-left-color: #10b981;"><small class="fw-bold opacity-75">PR√ìX. INSTAL:</small><br><span id="nextInstalacao" class="fw-bold fs-5 text-success">---</span></div></div>
        </div>
    </div>

    <div class="card-kpi p-0 overflow-hidden shadow-sm">
        <table class="table align-middle mb-0"><thead class="table-light small"><tr><th class="ps-3">DATA</th><th>CLIENTE</th><th>UF</th><th>T√âCNICO</th></tr></thead><tbody id="tableBody" class="small"></tbody></table>
    </div>
</div>

<script>
    const API_KEY = 'AIzaSyAJ76u1-OKw44iwslkw274XYe4B_X9w7Ng';
    const SHEET_ID = '1271NhAjUYYTPWhWrgNHgEhdytoDFsshFvj-o01-7Wbc';
    const TECS = ["TEC cleydson Cear√°", "TEC Daniel", "TEC Franklin", "TEC Dervis", "TEC Rodrigo", "TEC Marcus", "TEC instalador Ricardo", "TEC instalador Pedro"];
    let rawData = [];

    async function init() {
        try {
            // Busca o nome da primeira aba automaticamente
            const meta = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`).then(r => r.json());
            if (meta.error) throw new Error(meta.error.message);
            
            const firstSheet = meta.sheets[0].properties.title;
            const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(firstSheet)}!A2:E2000?key=${API_KEY}`).then(r => r.json());
            
            if (!res.values) {
                document.getElementById('statusText').innerText = "PLANILHA VAZIA";
                return;
            }

            rawData = res.values.map(r => ({ tec: r[0]||'', uf: r[1]||'', atividade: r[2]||'', data: r[3]||'', cliente: r[4]||'' }));
            const select = document.getElementById('filterUf');
            [...new Set(rawData.map(d => d.uf))].filter(u => u).sort().forEach(uf => select.add(new Option(uf, uf)));
            
            document.getElementById('statusDot').className = 'dot dot-online';
            document.getElementById('statusText').innerText = 'ONLINE';
            processData();
        } catch (e) {
            document.getElementById('statusText').innerText = "ERRO: VERIFIQUE ACESSO DA PLANILHA";
            console.error("Erro detalhado:", e);
        }
    }

    function processData() {
        const uf = document.getElementById('filterUf').value;
        const filtered = rawData.filter(d => uf === "TODOS" || d.uf === uf);
        document.getElementById('kpiVisitas').innerText = filtered.filter(d => d.atividade.toLowerCase().includes("visita")).length;
        document.getElementById('kpiInstalacoes').innerText = filtered.filter(d => d.atividade.toLowerCase().includes("instala")).length;
        document.getElementById('kpiTotal').innerText = [...new Set(filtered.map(d => d.tec))].filter(t => t).length;

        const getNext = (tipo) => {
            const hist = rawData.filter(d => d.atividade.toLowerCase().includes(tipo.toLowerCase())).reverse();
            if (!hist.length) return TECS[0];
            const last = hist[0].tec;
            const idx = TECS.indexOf(last);
            return TECS[(idx + 1) % TECS.length];
        };

        document.getElementById('nextVT').innerText = getNext("visita");
        document.getElementById('nextInstalacao').innerText = getNext("instala");
        document.getElementById('tableBody').innerHTML = filtered.slice(0, 50).map(r => `<tr><td class="ps-3">${r.data}</td><td><b>${r.cliente}</b></td><td><span class="badge-uf">${r.uf}</span></td><td>${r.tec}</td></tr>`).join('');
    }
    window.onload = init;
</script>
</body>
</html>
